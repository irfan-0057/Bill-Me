<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bismilla Traders - Bills History</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <a href="{{ url_for('dashboard') }}" class="sidebar-item">Dashboard</a>
        <a href="{{ url_for('inventory_selection') }}" class="sidebar-item">Inventory</a>
        <a href="{{ url_for('billing_selection') }}" class="sidebar-item">Billing</a>
        <a href="{{ url_for('bills_selection') }}" class="sidebar-item active">Bills</a>
        <a href="{{ url_for('reports_selection') }}" class="sidebar-item">Reports</a>
    </div>

    <div class="content">
        <h1 id="pageTitle">Bills History</h1>
        <div class="form-section">
            <div class="input-group">
                <label for="billSearch">Search by Bill Number:</label>
                <input type="text" id="billSearch" placeholder="Enter Bill Number (e.g., F-101)">
            </div>
        </div>
        <div class="table-container">
            <h2>All Bills</h2>
            <table id="bills-table">
                <thead>
                    <tr>
                        <th>Bill No.</th>
                        <th>Customer Name</th>
                        <th>Bill Date</th>
                        <th>Grand Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="bills-table-body">
                    </tbody>
            </table>
            <p id="no-results-message" style="display: none;">No bills found with that number.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const billSearchInput = document.getElementById('billSearch');
            const billsTableBody = document.getElementById('bills-table-body');
            const noResultsMessage = document.getElementById('no-results-message');
            let allBills = [];

            // Get the product type from the URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const productType = urlParams.get('product_type');

            if (!productType) {
                alert('Product type is missing from URL.');
                return;
            }
            
            // Set the dynamic page title
            document.getElementById('pageTitle').textContent = `${productType.charAt(0).toUpperCase() + productType.slice(1)} Bills History`;

            try {
                // Updated: Fetch bills from the new route with the product_type
                const response = await fetch(`/get_bills/${productType}`);
                allBills = await response.json();
                renderBills(allBills);
            } catch (error) {
                console.error('Error fetching bills:', error);
                billsTableBody.innerHTML = '<tr><td colspan="5">Error loading bills.</td></tr>';
            }

            billSearchInput.addEventListener('input', function() {
                const searchTerm = billSearchInput.value.trim().toUpperCase(); // Convert to uppercase for consistent matching
                const filteredBills = allBills.filter(bill => String(bill.bill_number).includes(searchTerm));
                renderBills(filteredBills);
            });

            function renderBills(bills) {
                billsTableBody.innerHTML = '';
                if (bills.length === 0) {
                    noResultsMessage.style.display = 'block';
                    return;
                }
                noResultsMessage.style.display = 'none';

                bills.forEach(bill => {
                    const row = billsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${bill.bill_number}</td>
                        <td>${bill.customer_name}</td>
                        <td>${bill.bill_date}</td>
                        <td>â‚¹${bill.grand_total.toFixed(2)}</td>
                        <td>
                            <a href="/view_bill/${bill.bill_number}" class="button primary" target="_blank">View</a>
                            <button class="button danger" onclick="cancelBill('${bill.bill_number}')">Cancel</button>
                        </td>
                    `;
                });
            }

            // New JavaScript function to handle bill cancellation
            function cancelBill(billNumber) {
                if (confirm(`Are you sure you want to cancel bill number ${billNumber}? This action is irreversible and will restore products to inventory.`)) {
                    // Updated: Send the string billNumber to the new route
                    fetch(`/cancel_bill/${billNumber}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.success);
                            // Refresh the page to show the updated bill list
                            window.location.reload();
                        } else {
                            alert(`Error: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while trying to cancel the bill.');
                    });
                }
            }
        });
    </script>
</body>
</html>
