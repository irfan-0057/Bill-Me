<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bismilla Traders - Bills ({{ product_type }})</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <a href="{{ url_for('dashboard') }}" class="sidebar-item">Dashboard</a>
        <a href="{{ url_for('inventory_selection') }}" class="sidebar-item">Inventory</a>
        <a href="{{ url_for('billing_selection') }}" class="sidebar-item">Billing</a>
        <a href="{{ url_for('bills') }}" class="sidebar-item">Bills</a>
        <a href="{{ url_for('reports_selection') }}" class="sidebar-item">Reports</a>
    </div>

    <div class="content">
        <h1>Bills - {{ product_type.capitalize() }}</h1>

        <div class="form-section">
            <div class="input-group">
                <label for="billSearch">Search (Bill #, Customer, Date):</label>
                <input id="billSearch" type="text" placeholder="Search...">
            </div>
        </div>

        <div class="table-container">
            <h2>All Bills</h2>
            <table id="bills-table">
                <thead>
                    <tr>
                        <th>Bill No.</th>
                        <th>Customer Name</th>
                        <th>Bill Date</th>
                        <th>Grand Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="bills-table-body"></tbody>
            </table>
            <p id="no-results-message" style="display:none;">No bills found.</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const productType = "{{ product_type }}";
        const billsTableBody = document.getElementById('bills-table-body');
        const searchInput = document.getElementById('billSearch');
        const noResults = document.getElementById('no-results-message');
        let allBills = [];

        async function loadBills() {
            try {
                const res = await fetch(`/get_bills?product_type=${productType}`);
                allBills = await res.json();
                render(allBills);
            } catch (err) {
                console.error(err);
                billsTableBody.innerHTML = '<tr><td colspan="5">Error loading bills.</td></tr>';
            }
        }

        function render(bills) {
            billsTableBody.innerHTML = '';
            if (!Array.isArray(bills) || bills.length === 0) {
                noResults.style.display = 'block';
                return;
            }
            noResults.style.display = 'none';
            bills.forEach(b => {
                const row = billsTableBody.insertRow();
                row.innerHTML = `
                    <td>${b.bill_number}</td>
                    <td>${b.customer_name}</td>
                    <td>${b.bill_date}</td>
                    <td>â‚¹${Number(b.grand_total).toFixed(2)}</td>
                    <td>
                        <a class="button primary" href="/view_bill/${b.bill_number}" target="_blank">View</a>
                        {% if g.role == 'admin' %}
                        <button class="button danger" onclick="cancelBill(${b.bill_number})">Cancel</button>
                        {% endif %}
                    </td>
                `;
            });
        }

        searchInput.addEventListener('input', () => {
            const q = searchInput.value.trim().toLowerCase();
            const filtered = allBills.filter(b =>
                String(b.bill_number).startsWith(q) ||
                b.customer_name.toLowerCase().includes(q) ||
                b.bill_date.includes(q)
            );
            render(filtered);
        });

        await loadBills();
    });

    function cancelBill(billNumber) {
        if (!confirm(`Cancel bill ${billNumber}? This will revert stock and permanently renumber bills.`)) return;
        fetch(`/cancel_bill/${billNumber}`, { method: 'POST', headers: {'Content-Type':'application/json'} })
            .then(async r => {
                const data = await r.json();
                if (r.ok && data.success) {
                    alert(data.success);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error cancelling bill');
            });
    }
    </script>
</body>
</html>
