<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bismilla Traders - {{ bill_type_title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <a href="{{ url_for('dashboard') }}" class="sidebar-item">Dashboard</a>
        <a href="{{ url_for('inventory_selection') }}" class="sidebar-item">Inventory</a>
        <a href="{{ url_for('billing_selection') }}" class="sidebar-item">Billing</a>
        <a href="{{ url_for('bills_selection') }}" class="sidebar-item active">Bills</a>
        <a href="{{ url_for('reports_selection') }}" class="sidebar-item">Reports</a>
    </div>

    <div class="content">
        <h1>{{ bill_type_title }}</h1>
        <div class="form-section">
            <div class="input-group">
                <label for="billSearch">Search by Bill Number or Customer:</label>
                <input type="text" id="billSearch" placeholder="Enter Bill Number or Name">
            </div>
        </div>
        <div class="table-container">
            <table id="bills-table">
                <thead>
                    <tr>
                        <th>Bill No.</th>
                        <th>Customer Name</th>
                        <th>Bill Date</th>
                        <th>Grand Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="bills-table-body">
                    </tbody>
            </table>
            <p id="no-results-message" style="display: none;">No bills found for this category.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // This gets the bill type from the URL, which we'll pass to the API
            const billType = "{{ bill_type }}";

            const billSearchInput = document.getElementById('billSearch');
            const billsTableBody = document.getElementById('bills-table-body');
            const noResultsMessage = document.getElementById('no-results-message');
            let allBills = [];

            try {
                // UPDATE: The fetch URL now includes the bill type
                const response = await fetch(`/get_bills?type=${billType}`);
                allBills = await response.json();
                renderBills(allBills);
            } catch (error) {
                console.error('Error fetching bills:', error);
                billsTableBody.innerHTML = '<tr><td colspan="5">Error loading bills.</td></tr>';
            }

            billSearchInput.addEventListener('input', function() {
                const searchTerm = billSearchInput.value.trim().toLowerCase();
                const filteredBills = allBills.filter(bill =>
                    String(bill.bill_number).toLowerCase().includes(searchTerm) ||
                    bill.customer_name.toLowerCase().includes(searchTerm)
                );
                renderBills(filteredBills);
            });

            function renderBills(bills) {
                billsTableBody.innerHTML = '';
                if (bills.length === 0) {
                    noResultsMessage.style.display = 'block';
                    return;
                }
                noResultsMessage.style.display = 'none';

                bills.forEach(bill => {
                    const encodedBillNumber = encodeURIComponent(bill.bill_number);
                    const row = billsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${bill.bill_number}</td>
                        <td>${bill.customer_name}</td>
                        <td>${bill.bill_date}</td>
                        <td>â‚¹${bill.grand_total.toFixed(2)}</td>
                        <td>
                            <a href="/view_bill/${encodedBillNumber}" class="button primary" target="_blank">View</a>
                            <button class="button danger" onclick="cancelBill('${bill.bill_number}')">Cancel</button>
                        </td>
                    `;
                });
            }
        });

        // This cancel function remains the same and will work correctly
        function cancelBill(billNumber) {
            if (confirm(`Are you sure you want to cancel bill number ${billNumber}?`)) {
                fetch(`/cancel_bill/${encodeURIComponent(billNumber)}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.success);
                        window.location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while trying to cancel the bill.');
                });
            }
        }
    </script>
</body>
</html>
